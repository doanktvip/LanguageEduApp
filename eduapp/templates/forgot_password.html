{% extends 'layout/base.html' %}

{% block title %}Khôi phục mật khẩu{% endblock %}

{% block card_header %}
<div class="d-none"></div>
{% endblock %}

{% block card_body %}
<div class="row justify-content-center">
    <div class="col-md-10 col-lg-8">
        <div class="text-center mb-4 mt-2">
            <div class="bg-warning bg-opacity-10 text-warning rounded-circle d-inline-flex align-items-center justify-content-center mb-3"
                 style="width: 70px; height: 70px;">
                <i class="bi bi-key-fill fs-2"></i>
            </div>
            <h4 class="fw-bold text-dark">Khôi phục mật khẩu</h4>
        </div>
        <div class="position-relative mb-5 mx-4">
            <div class="progress" style="height: 2px;">
                <div class="progress-bar bg-warning" role="progressbar"
                     style="width: {{ '0%' if not show_step2 else '100%' }}; transition: width 0.5s ease;"></div>
            </div>
            <button type="button"
                    class="position-absolute top-0 start-0 translate-middle btn btn-sm rounded-pill {{ 'btn-warning text-dark' if not show_step2 else 'btn-success text-white' }} fw-bold shadow-sm"
                    style="width: 2rem; height: 2rem;">
                {% if show_step2 %}<i class="bi bi-check"></i>{% else %}1{% endif %}
            </button>
            <button type="button"
                    class="position-absolute top-0 start-100 translate-middle btn btn-sm rounded-pill {{ 'btn-warning text-dark' if show_step2 else 'btn-secondary text-white' }} fw-bold shadow-sm"
                    style="width: 2rem; height: 2rem;">2
            </button>
        </div>
        {% if err_msg %}
        <div class="alert alert-danger d-flex align-items-center border-0 shadow-sm mb-4 py-2" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <div class="small">{{ err_msg }}</div>
        </div>
        {% endif %}
        <div class="collapse {% if not show_step2 %}show{% endif %}" id="step1">
            <form method="post">
                <input type="hidden" name="step" value="1">
                <div class="form-floating mb-3">
                    <input type="text" class="form-control" name="username" id="username" placeholder="Tài khoản"
                           required value="{{ data.get('username', '') }}"
                           oninput="this.value = this.value.replace(/\s/g, '')">
                    <label for="username"><i class="bi bi-person me-1"></i>Tên đăng nhập</label>
                </div>
                <div class="form-floating mb-4">
                    <input type="email" class="form-control" id="email" name="email" placeholder="Email"
                           required value="{{ data.get('email', '') }}"
                           oninput="this.value = this.value.replace(/^\s+/g, '')">
                    <label for="email"><i class="bi bi-envelope me-1"></i>Email đăng ký</label>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <a href="/login" class="text-decoration-none small text-secondary">
                        <i class="bi bi-arrow-left me-1"></i>Về đăng nhập
                    </a>
                    <button class="btn btn-primary px-4 fw-bold shadow-sm" type="submit">
                        Tiếp theo <i class="bi bi-arrow-right ms-1"></i>
                    </button>
                </div>
            </form>
        </div>
        <div class="collapse {% if show_step2 %}show{% endif %}" id="step2">
            <form method="post">
                {% set otp_valid = data.get('otp_code') %}
                {% if otp_valid %}
                <input type="hidden" name="step" value="2">
                <div class="mb-4 text-center">
                    <label class="form-label small text-muted fw-bold">NHẬP MÃ XÁC NHẬN (6 SỐ)</label>
                    <input type="text" class="form-control text-center fw-bold text-primary fs-4"
                           id="verify" name="verify" placeholder="######"
                           required minlength="6" maxlength="6" pattern="[0-9]{6}" autocomplete="off"
                           style="letter-spacing: 0.5em; font-family: monospace;"
                           oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                </div>
                <hr class="text-secondary opacity-25 my-4">
                <div class="form-floating mb-3 position-relative">
                    <input type="password" class="form-control" id="new_password" name="new_password"
                           placeholder="Mật khẩu mới" required minlength="6" maxlength="20">
                    <label for="new_password">Mật khẩu mới</label>
                    <div class="invalid-feedback">
                        Mật khẩu phải từ 6 đến 20 ký tự.
                    </div>
                </div>
                <div class="form-floating mb-3 position-relative">
                    <input type="password" class="form-control" id="re_enter_password" name="re_enter_password"
                           placeholder="Nhập lại" required minlength="6" maxlength="20">
                    <label for="re_enter_password">Xác nhận mật khẩu</label>
                    <div class="invalid-feedback">
                        Vui lòng nhập lại mật khẩu khớp với bên trên.
                    </div>
                </div>
                <div class="d-grid">
                    <button class="btn btn-primary px-4 fw-bold shadow-sm" type="submit">
                        <i class="bi bi-check-lg me-1"></i>Đổi mật khẩu
                    </button>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="bi bi-shield-x text-danger display-1 opacity-25"></i>
                    <h5 class="mt-3 text-danger fw-bold">Mã xác nhận đã bị vô hiệu hóa</h5>
                    <p class="text-muted small">
                        Do bạn đã nhập sai mã xác nhận hoặc mã đã hết hạn. <br>
                        Vui lòng lấy mã mới để tiếp tục.
                    </p>
                    <button type="submit" name="step" value="resend" formnovalidate
                            class="btn btn-warning fw-bold shadow-sm px-4 py-2 mt-2">
                        <i class="bi bi-envelope-paper me-2"></i>Gửi mã xác nhận mới
                    </button>
                </div>
                {% endif %}
            </form>
        </div>
    </div>
</div>
{% endblock %}