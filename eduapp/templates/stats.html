{% extends 'layout/base.html' %}

{% block title %}Thống kê - Báo cáo{% endblock %}

{% block card_header %}
<div class="p-3">
    <div class="row align-items-center">
        <div class="col-12 col-sm text-center text-sm-start mb-2 mb-sm-0">
            <span class="text-uppercase fw-bold h5 m-0 d-block d-sm-inline">
                <i class="bi bi-bar-chart-fill me-2"></i>Thống kê - Báo cáo
            </span>
        </div>

        <div class="col-12 col-sm-auto">
            <a href="{{ url_for('export_stats', year=current_year) }}"
               class="btn btn-sm btn-outline-primary w-100 d-block d-sm-inline-block">
                <i class="bi bi-file-earmark-arrow-down me-1"></i>Xuất Excel
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block card_body %}

<div class="row mb-4">
    <div class="col-xl-6 col-md-6 mb-4">
        <div class="card border-left-primary shadow h-100 py-2 border-0">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                            Tổng Doanh Thu ({{ current_year }})
                        </div>
                        <div class="h2 mb-0 font-weight-bold text-dark" id="displayTotalRevenue">
                            {{ "{:,.0f}".format(tong_doanh_thu_nam).replace(',', '.') }}
                            <small class="text-muted" style="font-size: 0.6em;">VNĐ</small>
                        </div>
                    </div>
                    <div class="col-auto">
                        <div class="rounded-circle bg-primary text-white p-3 d-flex align-items-center justify-content-center shadow-sm">
                            <i class="fas fa-dollar-sign fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-6 col-md-6 mb-4">
        <div class="card border-left-success shadow h-100 py-2 border-0">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                            Tổng Lượt Học Viên
                        </div>
                        <div class="h2 mb-0 font-weight-bold text-dark">
                            {{ tong_hoc_vien_he_thong }} <small class="text-muted" style="font-size: 0.6em;">Học
                            viên</small>
                        </div>
                    </div>
                    <div class="col-auto">
                        <div class="rounded-circle bg-success text-white p-3 d-flex align-items-center justify-content-center shadow-sm">
                            <i class="fas fa-users fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card shadow mb-4 border-0">
    <div class="card-header py-3 bg-white d-flex flex-column flex-md-row align-items-center justify-content-between border-0">
        <h6 class="m-0 font-weight-bold text-dark mb-2 mb-md-0 text-uppercase">
            Biểu Đồ Tăng Trưởng Doanh Thu
        </h6>

        <div class="d-flex align-items-center mt-2 mt-md-0">
            <label for="yearFilter"
                   class="mb-0 mr-2 text-xs font-weight-bold text-secondary text-uppercase">Năm:</label>
            <select id="yearFilter"
                    class="custom-select custom-select-sm shadow-none border-light bg-light font-weight-bold text-secondary"
                    style="width: auto;">
                {% for nam in ds_nam %}
                <option value="{{ nam }}" {% if nam== current_year %}selected{% endif %}>{{ nam }}</option>
                {% endfor %}
            </select>
        </div>
    </div>
    <div class="card-body">
        <div style="position: relative; height: var(--header-stats); width: 100%;">
            <canvas id="revenueChart"></canvas>
        </div>
    </div>
</div>

<div class="card shadow mb-4 border-0">
    <div class="card-header py-3 bg-white border-bottom-0">
        <div class="d-flex flex-column flex-md-row align-items-center justify-content-between">
            <h6 class="m-0 font-weight-bold text-dark mb-2 mb-md-0 text-uppercase">
                Chi Tiết Theo Khóa Học
            </h6>

            <div class="input-group input-group-sm" style="max-width: 300px;">
                <div class="input-group-prepend">
                    <span class="input-group-text bg-light border-0"><i class="fas fa-search text-gray-400"></i></span>
                </div>
                <select id="courseFilter"
                        class="custom-select bg-light border-0 font-weight-bold text-secondary shadow-none"
                        onchange="updateDetailCharts()">
                    {% for item in du_lieu_khoa_hoc_full %}
                    <option value="{{ loop.index0 }}">{{ item.ten_khoa_hoc }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>

    <div class="card-body pt-0">
        <div class="row">
            <div class="col-lg-6 mb-4">
                <div class="card h-100 border-0 bg-light">
                    <div class="card-body">
                        <h6 class="text-center font-weight-bold text-secondary mb-3 text-uppercase small">Sĩ Số Học
                            Viên</h6>
                        <div style="height: var(--header-stats-hv); position: relative;">
                            <canvas id="studentCountChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-6 mb-4">
                <div class="card h-100 border-0 bg-light">
                    <div class="card-body">
                        <h6 class="text-center font-weight-bold text-secondary mb-3 text-uppercase small">Tỷ lệ hoàn
                            thành</h6>
                        <div style="height: var(--header-stats-hv); position: relative;">
                            <canvas id="passRateChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascript %}
<script>
    Chart.defaults.font.family = "'Nunito', -apple-system, system-ui, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif";
    Chart.defaults.color = '#858796';

    const formatCurrency = (value) => new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(value);
    const masterDataCourses = {{ du_lieu_khoa_hoc_full | tojson }};
    const dataDoanhThuInit = {{ data_doanh_thu | tojson }};

    const ctxRevenue = document.getElementById('revenueChart').getContext('2d');
    let revenueChartObj = null;

    function initRevenueChart(data) {
        let gradient = ctxRevenue.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, 'rgba(78, 115, 223, 0.1)');
        gradient.addColorStop(1, 'rgba(78, 115, 223, 0.0)');

        revenueChartObj = new Chart(ctxRevenue, {
            type: 'line',
            data: {
                labels: ["T1", "T2", "T3", "T4", "T5", "T6", "T7", "T8", "T9", "T10", "T11", "T12"],
                datasets: [{
                    label: 'Doanh thu',
                    data: data,
                    backgroundColor: gradient,
                    borderColor: '#4e73df',
                    pointBackgroundColor: '#fff',
                    pointBorderColor: '#4e73df',
                    pointHoverBackgroundColor: '#4e73df',
                    pointHoverBorderColor: '#fff',
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                maintainAspectRatio: false,
                animation: { duration: 0 },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: "rgb(255,255,255)",
                        bodyColor: "#858796",
                        titleColor: '#6e707e',
                        borderColor: '#dddfeb',
                        borderWidth: 1,
                        callbacks: { label: function(context) { return 'Doanh thu: ' + formatCurrency(context.raw); } }
                    }
                },
                scales: {
                    x: { grid: { display: false, drawBorder: false } },
                    y: {
                        ticks: {
                            maxTicksLimit: 5, padding: 10,
                            callback: function(value) {
                                if (value >= 1000000000) return (value / 1000000000).toFixed(1) + ' tỷ';
                                if (value >= 1000000) return (value / 1000000).toFixed(0) + ' Tr';
                                return value;
                            }
                        },
                        grid: { color: "rgb(234, 236, 244)", borderDash: [2], drawBorder: false }
                    }
                }
            }
        });
    }

    document.getElementById('yearFilter').addEventListener('change', function() {
        const year = this.value;
        const btn = this;
        btn.disabled = true;
        fetch(`/api/revenue-chart?year=${year}`).then(res => res.json()).then(res => {
            if(res.status === 'success'){
                revenueChartObj.data.datasets[0].data = res.data;
                revenueChartObj.update();
                document.getElementById('displayTotalRevenue').innerHTML = `${res.formatted_total} <small class="text-muted" style="font-size: 0.6em;">VNĐ</small>`;
            }
        }).finally(() => btn.disabled = false);
    });

    let studentChart = null, passFailChart = null;
    function renderDetailCharts(course) {
        const ctxStu = document.getElementById('studentCountChart').getContext('2d');
        if (studentChart) studentChart.destroy();
        studentChart = new Chart(ctxStu, {
            type: 'bar',
            data: {
                labels: ['Tổng học viên'],
                datasets: [{
                    label: 'Số lượng', data: [course.so_luong_hv], backgroundColor: '#36b9cc', borderRadius: 4, barPercentage: 0.5
                }]
            },
            options: {
                maintainAspectRatio: false,
                animation: { duration: 0 },
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, ticks: { stepSize: 1 }, grid: { borderDash: [2], drawBorder: false } },
                    x: { grid: { display: false } }
                }
            }
        });

        const ctxPass = document.getElementById('passRateChart').getContext('2d');
        if (passFailChart) passFailChart.destroy();

        passFailChart = new Chart(ctxPass, {
            type: 'doughnut',
            data: {
                labels: ['Đạt', 'Rớt', 'Chưa KQ'],
                datasets: [{
                    label: 'Tỉ lệ',
                    data: [course.ty_le_dat, course.ty_le_rot, course.ty_le_chua_kq],
                    backgroundColor: ['#1cc88a', '#e74a3b', '#e3e6f0'],
                    borderWidth: 2,
                    borderColor: '#ffffff'
                }]
            },
            options: {
                maintainAspectRatio: false,
                animation: { duration: 0 },
                cutout: '70%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { usePointStyle: true, padding: 20 }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                return label + context.parsed + '%';
                            }
                        }
                    }
                }
            }
        });
    }

    function updateDetailCharts() {
        const idx = document.getElementById('courseFilter').value;
        if(masterDataCourses[idx]) renderDetailCharts(masterDataCourses[idx]);
    }

    document.addEventListener('DOMContentLoaded', () => {
        initRevenueChart(dataDoanhThuInit);
        if (masterDataCourses.length > 0) {
            document.getElementById('courseFilter').selectedIndex = 0;
            renderDetailCharts(masterDataCourses[0]);
        }
    });
</script>
{% endblock %}