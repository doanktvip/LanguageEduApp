{% extends 'layout/base.html' %}

{% block title %}Nhập điểm lớp học{% endblock %}

{% block card_header %}
<div class="d-flex justify-content-between align-items-center p-3 border-bottom">
    <h5 class="mb-0 fw-bold"><i class="bi bi-pencil-square me-2"></i>Quản lý điểm số</h5>
    {% if selected_course %}
    <span class="badge bg-light text-dark border">
        Mã lớp: <strong>{{ selected_course.ma_khoa_hoc }}</strong>
    </span>
    {% endif %}
</div>
{% endblock %}

{% block card_body %}
<div class="row g-3 mb-3">
    <div class="col-md-6">
        <form action="/grading" method="GET">
            <div class="input-group">
                <span class="input-group-text border-end-0 bg-white text-primary"><i class="bi bi-search"></i></span>
                <select name="course_id" class="form-select border-start-0 fw-bold text-primary"
                        onchange="this.form.submit()">
                    {% for kh in ds_khoa_hoc %}
                    <option value="{{ kh.ma_khoa_hoc }}" {% if selected_course and kh.ma_khoa_hoc==
                            selected_course.ma_khoa_hoc %}selected{% endif %}>
                        {{ kh.ten_khoa_hoc }}
                    </option>
                    {% endfor %}
                </select>
            </div>
        </form>
    </div>
    <div class="col-md-6 text-md-end">
        <div class="small text-muted fst-italic">
            <span class="badge bg-warning text-dark border me-1">Vàng</span> Lưu nháp
            <span class="badge bg-primary text-light border ms-2 me-1">Trắng</span> Lưu chốt
        </div>
    </div>
</div>
{% if selected_course %}
<form action="/grading" method="POST">
    <input type="hidden" name="course_id" value="{{ selected_course.ma_khoa_hoc }}">
    {% if not cau_truc_diem %}
    <div class="alert alert-warning text-center">
        <i class="bi bi-exclamation-triangle me-2"></i>Lớp này chưa được cấu hình cột điểm.
    </div>
    {% else %}
    <div class="table-responsive rounded shadow-sm">
        <table class="table table-bordered mb-0 align-middle text-center"
               style="border-collapse: separate; border-spacing: 0;">
            <thead class="bg-primary text-white header-row">
            <tr>
                <th class="sticky-cell col-fix-left ps-3 text-start">Học viên</th>
                {% for cot in cau_truc_diem %}
                <th class="bg-primary text-white py-2" style="min-width: 130px;">
                    <div class="small fw-normal opacity-75">{{ cot.ten_loai_diem }}</div>
                    <span class="badge bg-white text-primary bg-opacity-100 border border-white border-opacity-25 text-dark"
                          style="font-size: 0.7rem;">
                            {{ (cot.trong_so * 100)|int }}%
                        </span>
                </th>
                {% endfor %}
                <th class="bg-primary text-white">Tổng</th>
            </tr>
            </thead>
            <tbody>
            {% for row in bang_diem_data %}
            <tr>
                <td class="sticky-cell bg-light col-fix-left ps-3 text-start">
                    <div class="fw-bold text-truncate text-dark" style="max-width: 100%;">
                        {{ row.hoc_vien.ho_va_ten }}
                    </div>
                    <small class="text-muted font-monospace">{{ row.hoc_vien.ma_nguoi_dung }}</small>
                </td>
                {% for cot in cau_truc_diem %}
                {% set cell_data = row.diem_so.get(cot.ten_loai_diem) %}
                {% set diem_hien_tai = cell_data[0] if cell_data and cell_data[0] is not none else '' %}
                {% set is_draft = cell_data[2] if cell_data and cell_data|length > 2 else true %}
                {% set is_locked = (diem_hien_tai != '' and not is_draft) %}
                <td class="p-1">
                    <div class="position-relative">
                        <input type="number" step="0.1" min="0" max="10"
                               class="form-control form-control-sm text-center fw-bold input-score border
                                   {{ 'bg-light text-secondary' if is_locked else ('bg-warning bg-opacity-10 border-warning text-dark' if is_draft and diem_hien_tai != '' else 'bg-white text-primary') }}"
                               name="diem_{{ row.ma_bang_diem }}_{{ cot.id }}"
                               value="{{ diem_hien_tai }}"
                               placeholder="-"
                               {{ 'readonly tabindex=-1' if is_locked else '' }}
                        onfocus="this.select()">
                        {% if is_locked %}
                        <i class="bi bi-lock-fill text-muted position-absolute top-50 end-0 translate-middle-y me-2 opacity-50"
                           style="font-size: 0.6rem; pointer-events: none;"></i>
                        {% endif %}
                    </div>
                </td>
                {% endfor %}
                <td class="col-fix-right fw-bold bg-light border-start">
                    {% set tk = row.diem_so.get('Tổng kết') %}
                    {% if tk and tk[0] is not none %}
                    <span class="{{ 'text-success' if tk[0] >= 5.0 else 'text-danger' }} fs-6">
                                {{ tk[0] }}
                            </span>
                    {% else %}
                    <span class="text-muted opacity-25">-</span>
                    {% endif %}
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="{{ cau_truc_diem|length + 3 }}" class="text-center py-5">
                    <div class="text-muted opacity-50">
                        <i class="bi bi-people-fill display-4"></i>
                        <p class="mt-2">Lớp học chưa có học viên.</p>
                    </div>
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    <div class="d-flex justify-content-end gap-2 mt-3">
        <button type="submit" name="action_type" value="save_draft"
                class="btn btn-warning bg-opacity-10 text-dark border-warning fw-bold px-4">
            <i class="bi bi-pencil me-1"></i> Lưu Nháp
        </button>
        <button type="submit" name="action_type" value="publish"
                class="btn btn-primary fw-bold shadow-sm px-4"
                onclick="return confirm('Xác nhận chốt bảng điểm? Sau khi chốt, điểm số sẽ được tính toán và không thể sửa đổi ngay lập tức.')">
            <i class="bi bi-check-circle-fill me-1"></i> Lưu & Tính Điểm
        </button>
    </div>
    {% endif %}
</form>
{% else %}
<div class="alert alert-info text-center mt-5">
    <i class="bi bi-info-circle me-2"></i>Tài khoản giáo viên này chưa được phân công lớp học nào.
</div>
{% endif %}
{% endblock %}