{% extends 'layout/base.html' %}

{% block title %}Quản Lý Điểm Số{% endblock %}

{% block card_header %}
<div class="d-flex justify-content-between align-items-center p-3 border-bottom">
    <div class="d-flex align-items-center gap-2"><i class="bi bi-journal-bookmark-fill me-2"></i>Sổ Điểm Điện Tử
    </div>
    {% if selected_course %}
    <span class="badge bg-light text-dark border shadow-sm">Mã lớp: <strong>{{ selected_course.ma_khoa_hoc }}</strong>
    </span>
    {% endif %}
</div>
{% endblock %}

{% block card_body %}
<style>
    input {
        background-image: none !important;
    }
</style>
{% if msg %}
<div class="alert alert-{{ msg_type }} alert-dismissible fade show mb-4 shadow-sm" role="alert">
    <div class="d-flex align-items-center">
        {% if msg_type == 'success' %}
        <i class="bi bi-check-circle-fill fs-4 me-3 text-success"></i>
        {% else %}
        <i class="bi bi-exclamation-triangle-fill fs-4 me-3 text-danger"></i>
        {% endif %}
        <div>
            <strong>{{ 'Thành công!' if msg_type == 'success' else 'Đã xảy ra lỗi!' }}</strong>
            <br>{{ msg }}
        </div>
    </div>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endif %}
<div class="row g-3 mb-4">
    <div class="col-md-5">
        <form action="/grading" method="GET" id="form-select-course">
            <div class="input-group">
                <span class="input-group-text bg-white border-end-0 text-primary"><i class="bi bi-search"></i></span>
                <select name="course_id" class="form-select border-start-0 fw-bold text-primary"
                        onchange="document.getElementById('form-select-course').submit()">
                    {% for kh in ds_khoa_hoc %}
                    <option value="{{ kh.ma_khoa_hoc }}"
                            {% if selected_course and kh.ma_khoa_hoc== selected_course.ma_khoa_hoc %}selected{% endif
                            %}>
                        {{ kh.ten_khoa_hoc }}
                    </option>
                    {% endfor %}
                </select>
            </div>
        </form>
    </div>
    <div class="col-md-7 d-flex align-items-end justify-content-md-end">
        {% if selected_course and cau_truc_diem %}
        <div class="small text-muted fst-italic border p-2 rounded bg-light">
            <span class="me-3"><i class="bi bi-pencil-square me-1"></i>Nháp (Chưa tính điểm)</span>
            <span><i class="bi bi-check-circle-fill me-1"></i>Đã chốt (Đã tính điểm)</span>
        </div>
        {% endif %}
    </div>
</div>
{% if selected_course %}
{% if not cau_truc_diem %}
<div class="card border-warning shadow-sm">
    <div class="card-header bg-warning bg-opacity-10 border-bottom-0">
        <h5 class="mb-0 text-dark fw-bold"><i class="bi bi-gear-fill me-2"></i>Thiết lập cột điểm</h5>
    </div>
    <div class="card-body">
        <div class="alert alert-light border-warning d-flex align-items-center mb-4">
            <i class="bi bi-exclamation-triangle-fill text-warning fs-4 me-3"></i>
            <div>
                <strong>Lớp {{ selected_course.ten_khoa_hoc }} chưa được cấu hình điểm số.</strong><br>
                <span class="text-muted small">Vui lòng định nghĩa các đầu điểm (VD: Giữa kỳ, Cuối kỳ). Tổng trọng số phải bằng <strong>100%</strong>.</span>
            </div>
        </div>
        <form method="POST" action="/grading" id="form-config-grade">
            <input type="hidden" name="course_id" value="{{ selected_course.ma_khoa_hoc }}">
            <input type="hidden" name="action_type" value="create_structure">
            <div id="structure-container">
                <div class="row g-2 mb-2 structure-row align-items-center">
                    <div class="col-md-7">
                        <label class="small text-muted mb-1">Tên đầu điểm</label>
                        <input type="text" name="ten_thanh_phan[]" class="form-control" value="Giữa kỳ" required>
                    </div>
                    <div class="col-md-4">
                        <label class="small text-muted mb-1">Trọng số (%)</label>
                        <div class="input-group">
                            <input type="number" name="trong_so[]" class="form-control weight-input" value="30" min="1"
                                   max="100" required oninput="calcTotal()">
                            <span class="input-group-text">%</span>
                        </div>
                    </div>
                    <div class="col-md-1"></div>
                </div>
                <div class="row g-2 mb-2 structure-row align-items-center">
                    <div class="col-md-7">
                        <input type="text" name="ten_thanh_phan[]" class="form-control" value="Cuối kỳ" required>
                    </div>
                    <div class="col-md-4">
                        <div class="input-group">
                            <input type="number" name="trong_so[]" class="form-control weight-input" value="70" min="1"
                                   max="100" required oninput="calcTotal()">
                            <span class="input-group-text">%</span>
                        </div>
                    </div>
                    <div class="col-md-1">
                        <button type="button" class="btn btn-sm btn-outline-danger border-0" onclick="removeRow(this)">
                            <i class="bi bi-trash fs-5"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="d-flex justify-content-between align-items-center mt-4 pt-3 border-top">
                <button type="button" class="btn btn-outline-primary btn-sm rounded-pill px-3" onclick="addRow()">
                    <i class="bi bi-plus-lg me-1"></i>Thêm cột điểm
                </button>
                <div class="d-flex align-items-center gap-3">
                    <span class="fw-bold fs-5" id="total-display">Tổng: 100%</span>
                    <button type="submit" id="btn-save-struct" class="btn btn-primary fw-bold px-4 shadow-sm">
                        <i class="bi bi-save me-2"></i>Lưu Cấu Trúc
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>
{% else %}
<form action="/grading" method="POST" id="grading-form">
    <input type="hidden" name="course_id" value="{{ selected_course.ma_khoa_hoc }}">
    <div class="table-responsive rounded shadow-sm border bg-white mb-3" style="max-height: 65vh;">
        <table class="table table-bordered mb-0 align-middle text-center"
               style="border-collapse: separate; border-spacing: 0;">
            <thead class="header-row sticky-top">
            <tr>
                <th class="col-fix-left ps-3 text-start bg-primary text-white py-3 shadow-sm">
                    <i class="bi bi-person-lines-fill me-2"></i>Học viên
                </th>
                {% for cot in cau_truc_diem %}
                <th class="bg-primary text-white py-3" style="min-width: 140px;">
                    <div class="fw-bold">{{ cot.ten_loai_diem }}</div>
                    <span class="badge bg-white text-primary bg-opacity-100 text-dark rounded-pill px-2 py-1 mt-1"
                          style="font-size: 0.7rem;">
                                {{ (cot.trong_so * 100)|int }}%
                    </span>
                </th>
                {% endfor %}
                <th class="bg-primary text-white py-3 shadow-sm" style="min-width: 100px;">Tổng kết</th>
            </tr>
            </thead>
            <tbody>
            {% for row in bang_diem_data %}
            <tr>
                <td class="col-fix-left bg-light ps-3 text-start">
                    <div class="fw-bold text-dark">{{ row.hoc_vien.ho_va_ten }}</div>
                    <small class="text-muted font-monospace">{{ row.hoc_vien.ma_nguoi_dung }}</small>
                </td>
                {% for cot in cau_truc_diem %}
                {% set cell_data = row.diem_so.get(cot.ten_loai_diem) %}
                {% set diem_val = cell_data[0] if cell_data and cell_data[0] is not none else '' %}
                {% set is_draft = cell_data[2] if cell_data and cell_data|length > 2 else true %}
                {% set is_locked = (diem_val != '' and not is_draft) %}
                <td class="p-2 position-relative">
                    <input type="number" step="0.1" min="0" max="10"
                           class="form-control form-control-sm text-center fw-bold fs-6 input-score
                                    {{ 'bg-light text-secondary border-0' if is_locked else
                                       ('bg-warning bg-opacity-10 border-warning text-dark' if diem_val != '' and is_draft else '') }}"
                           name="diem_{{ row.ma_bang_diem }}_{{ cot.id }}" value="{{ diem_val }}"
                           placeholder="-" {{ 'readonly tabindex=-1' if is_locked else '' }} onfocus="this.select()">
                    {% if is_locked %}
                    <i class="bi bi-lock-fill text-muted position-absolute top-50 end-0 translate-middle-y me-3 opacity-50"
                       style="font-size: 0.7rem;"></i>
                    {% endif %}
                </td>
                {% endfor %}
                <td class="fw-bold bg-light border-start">
                    {% set tk = row.diem_so.get('Tổng kết') %}
                    {% if tk and tk[0] is not none %}
                    <span class="{{ 'text-success' if tk[0] >= 5.0 else 'text-danger' }} fs-5">
                                    {{ tk[0] }}
                                </span>
                    {% else %}
                    <span class="text-muted opacity-25">-</span>
                    {% endif %}
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="{{ cau_truc_diem|length + 2 }}" class="text-center py-5">
                    <div class="text-muted opacity-50">
                        <i class="bi bi-people-fill display-4"></i>
                        <p class="mt-2">Khóa học này chưa có học viên nào đăng ký.</p>
                    </div>
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    <div class="d-flex justify-content-end gap-2 pt-2 border-top">
        <button type="submit" name="action_type" value="save_draft"
                class="btn btn-light border text-dark fw-bold px-4 hover-shadow">
            <i class="bi bi-pencil-square me-2 text-warning"></i>Lưu Nháp
        </button>
        <button type="submit" name="action_type" value="publish" class="btn btn-primary fw-bold px-4 shadow-sm"
                onclick="return confirm('CẢNH BÁO: Điểm sau khi CHỐT sẽ được tính vào điểm tổng kết và không thể sửa đổi ngay lập tức.\n\nBạn có chắc chắn muốn chốt điểm không?')">
            <i class="bi bi-check-circle-fill me-2"></i>Lưu & Chốt Điểm
        </button>
    </div>
</form>
{% endif %}
{% else %}
<div class="text-center py-5 mt-4">
    <div class="mb-3">
        <i class="bi bi-journal-x display-1 text-muted opacity-25"></i>
    </div>
    <h4 class="text-muted">Chưa có dữ liệu lớp học</h4>
    <p class="text-muted small">Bạn hiện không được phân công phụ trách lớp học nào.</p>
</div>
{% endif %}
{% endblock %}

{% block javascript %}
<script>
    function calcTotal() {
        let total = 0;
        document.querySelectorAll('.weight-input').forEach(input => {
            total += parseInt(input.value) || 0;
        });
        const display = document.getElementById('total-display');
        const btn = document.getElementById('btn-save-struct');
        display.innerText = `Tổng: ${total}%`;
        if (total === 100) {
            display.className = 'fw-bold fs-5 text-success';
            btn.disabled = false;
        } else {
            display.className = 'fw-bold fs-5 text-danger';
            btn.disabled = true;
        }
    }
    function addRow() {
        const container = document.getElementById('structure-container');
        const div = document.createElement('div');
        div.className = 'row g-2 mb-2 structure-row align-items-center';
        div.innerHTML = `
            <div class="col-md-7">
                <input type="text" name="ten_thanh_phan[]" class="form-control" placeholder="Tên đầu điểm (VD: Chuyên cần)" required>
            </div>
            <div class="col-md-4">
                <div class="input-group">
                    <input type="number" name="trong_so[]" class="form-control weight-input" placeholder="0" min="1" max="100" required oninput="calcTotal()">
                    <span class="input-group-text">%</span>
                </div>
            </div>
            <div class="col-md-1">
                <button type="button" class="btn btn-sm btn-outline-danger border-0" onclick="removeRow(this)"><i class="bi bi-trash fs-5"></i></button>
            </div>
        `;
        container.appendChild(div);
        calcTotal();
    }
    function removeRow(btn) {
        btn.closest('.structure-row').remove();
        calcTotal();
    }
    document.addEventListener("DOMContentLoaded", function() { calcTotal(); });
</script>
{% endblock %}