{% extends 'layout/base.html' %}

{% block title %}Đăng ký khóa học{% endblock %}

{% block card_header %}
<div class="p-3">
    <div class="row align-items-center">
        <div class="col-12 col-sm text-center text-sm-start mb-2 mb-sm-0">
            <span class="text-uppercase fw-bold h5 m-0 d-block d-sm-inline">
                <i class="bi bi-cart-plus me-2"></i>ĐĂNG KÝ KHÓA HỌC
            </span>
        </div>
        {% if current_user.ma_nguoi_dung != target_user.ma_nguoi_dung %}
        <div class="col-12 col-sm-auto">
            <span class="badge bg-warning text-dark border shadow-sm">
                <i class="bi bi-person-fill me-1"></i>HV: {{ target_user.ho_va_ten }}
            </span>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block card_body %}

{% if thong_bao %}
<div class="alert alert-light border border-secondary border-opacity-25 shadow-sm mb-4">
    <div class="d-flex align-items-center mb-2">
        <i class="bi bi-bell-fill text-warning me-2 fs-5"></i>
        <span class="fw-bold text-dark">Kết quả xử lý:</span>
    </div>
    <ul class="list-group list-group-flush">
        {% for item in thong_bao %}
        <li class="list-group-item bg-transparent py-1 border-0 ps-0">
            {% if item.type == 'success' %}
            <i class="bi bi-check-circle-fill text-success me-2"></i>
            <span class="text-success fw-medium">{{ item.content }}</span>
            {% else %}
            <i class="bi bi-exclamation-triangle-fill text-danger me-2"></i>
            <span class="text-danger fw-medium">{{ item.content }}</span>
            {% endif %}
        </li>
        {% endfor %}
    </ul>
</div>
{% endif %}

<div class="bg-light p-3 rounded mb-4 border shadow-sm">
    <form method="GET" action="{{ url_for('register_course') }}" class="row g-2">
        {% if request.args.get('ma_hoc_vien') %}
        <input type="hidden" name="ma_hoc_vien" value="{{ request.args.get('ma_hoc_vien') }}">
        {% endif %}

        <div class="col-lg-3 col-md-6">
            <label class="form-label small fw-bold text-secondary mb-1">Từ khóa</label>
            <div class="input-group input-group-sm">
                <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
                <input type="text" name="kw" class="form-control" placeholder="Mã hoặc tên khóa..."
                       value="{{ request.args.get('kw', '') }}">
            </div>
        </div>

        <div class="col-lg-3 col-md-6">
            <label class="form-label small fw-bold text-secondary mb-1">Loại khóa học</label>
            <select name="cate_id" class="form-select form-select-sm">
                <option value="">-- Tất cả --</option>
                {% for c in categories %}
                <option value="{{ c.ma_loai_khoa_hoc }}" {% if request.args.get(
                'cate_id') == c.ma_loai_khoa_hoc %}selected{% endif %}>
                {{ c.ten_loai_khoa_hoc }}
                </option>
                {% endfor %}
            </select>
        </div>

        <div class="col-lg-4 col-md-8">
            <label class="form-label small fw-bold text-secondary mb-1">Ngày bắt đầu (Từ - Đến)</label>
            <div class="input-group input-group-sm">
                <input type="date" name="from_date" class="form-control"
                       value="{{ request.args.get('from_date', '') }}">
                <span class="input-group-text bg-white px-2"><i class="bi bi-arrow-right-short"></i></span>
                <input type="date" name="to_date" class="form-control"
                       value="{{ request.args.get('to_date', '') }}">
            </div>
        </div>

        <div class="col-lg-2 col-md-4 d-flex align-items-end mt-3 mt-lg-0">
            <div class="d-flex w-100 gap-2">
                <button type="submit" class="btn btn-primary btn-sm flex-grow-1 fw-bold">
                    <i class="bi bi-funnel-fill me-1"></i>Lọc
                </button>
                <a href="{{ url_for('register_course', ma_hoc_vien=request.args.get('ma_hoc_vien')) }}"
                   class="btn btn-outline-secondary btn-sm" title="Xóa bộ lọc">
                    <i class="bi bi-arrow-counterclockwise"></i>
                </a>
            </div>
        </div>
    </form>
</div>

{% if ds_khoa_hoc %}
<form action="{{ url_for('register_course', ma_hoc_vien=request.args.get('ma_hoc_vien')) }}" method="POST"
      id="form-dang-ky">

    <div class="table-responsive d-none d-md-block border rounded shadow-sm bg-white mb-4">
        <table class="table table-hover table-bordered align-middle text-nowrap mb-0">
            <thead class="table-light text-secondary small text-uppercase fw-bold">
            <tr>
                <th class="text-center bg-light" style="width: 50px;">
                    <i class="bi bi-check2-square fs-5"></i>
                </th>
                <th class="bg-light">Khóa học</th>
                <th class="bg-light">Giáo viên</th>
                <th class="text-center bg-light">Thời gian</th>
                <th class="text-center bg-light" style="width: 150px;">Sĩ số</th>
                <th class="text-end bg-light">Học phí</th>
            </tr>
            </thead>
            <tbody>
            {% for kh in ds_khoa_hoc %}
            {% set het_cho = kh.si_so_hien_tai >= kh.si_so_toi_da %}
            <tr class="{{ 'bg-light text-muted opacity-75' if het_cho else '' }}">
                <td class="text-center">
                    <div class="form-check d-flex justify-content-center">
                        <input class="form-check-input border-2 border-secondary course-checkbox"
                               style="transform: scale(1.2); cursor: pointer;"
                               type="checkbox"
                               name="course_ids"
                               value="{{ kh.ma_khoa_hoc }}"
                               id="chk_{{ kh.ma_khoa_hoc }}"
                               {% if het_cho %}disabled{% endif %}>
                    </div>
                </td>
                <td style="min-width: 250px; white-space: normal;">
                    <label for="chk_{{ kh.ma_khoa_hoc }}" style="cursor: pointer;" class="w-100">
                        <div class="fw-bold {{ 'text-secondary' if het_cho else 'text-primary' }}">
                            {{ kh.ten_khoa_hoc }}
                        </div>
                        <div class="d-flex gap-2 mt-1">
                            <span class="badge bg-light text-dark border font-monospace">{{ kh.ma_khoa_hoc }}</span>
                            <span class="badge bg-light text-secondary border">
                                    {{ kh.loai_khoa_hoc.ten_loai_khoa_hoc if kh.loai_khoa_hoc else 'Chưa phân loại' }}
                                </span>
                        </div>
                    </label>
                </td>
                <td>
                    <i class="bi bi-person-badge me-1 text-secondary"></i>
                    {{ kh.giao_vien.ho_va_ten if kh.giao_vien else "Chưa phân công" }}
                </td>
                <td class="text-center small">
                    <div>{{ kh.ngay_bat_dau.strftime('%d/%m/%Y') }}</div>
                    <i class="bi bi-arrow-down-short text-muted"></i>
                    <div>{{ kh.ngay_ket_thuc.strftime('%d/%m/%Y') }}</div>
                </td>
                <td>
                    {% if het_cho %}
                    <span class="badge bg-secondary w-100 py-2"><i class="bi bi-lock-fill me-1"></i>Đã đầy</span>
                    {% else %}
                    <div class="d-flex justify-content-between small fw-bold mb-1">
                        <span class="text-success">{{ kh.si_so_hien_tai }}</span>
                        <span class="text-muted">/ {{ kh.si_so_toi_da }}</span>
                    </div>
                    {% set percent = (kh.si_so_hien_tai / kh.si_so_toi_da * 100)|int %}
                    <div class="progress" style="height: 6px;">
                        <div class="progress-bar {{ 'bg-warning' if percent > 80 else 'bg-success' }}"
                             style="width: {{ percent }}%"></div>
                    </div>
                    {% endif %}
                </td>
                <td class="text-end">
                    <div class="fw-bold font-monospace fs-6 text-dark">
                        {{ "{:,.0f}".format(kh.hoc_phi) if kh.hoc_phi else '0' }} ₫
                    </div>
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="d-block d-md-none">
        {% for kh in ds_khoa_hoc %}
        {% set het_cho = kh.si_so_hien_tai >= kh.si_so_toi_da %}

        <label for="chk_mb_{{ kh.ma_khoa_hoc }}" class="card mb-3 shadow-sm border-0 w-100"
               style="cursor: pointer; {{ 'opacity: 0.7; background-color: #f8f9fa;' if het_cho else '' }}">
            <div class="card-body">
                <div class="d-flex align-items-start gap-3">
                    <div class="pt-1">
                        <input class="form-check-input border-2 border-secondary course-checkbox"
                               type="checkbox"
                               name="course_ids"
                               value="{{ kh.ma_khoa_hoc }}"
                               id="chk_mb_{{ kh.ma_khoa_hoc }}"
                               {% if het_cho %}disabled{% endif %}
                               style="transform: scale(1.3);">
                    </div>

                    <div class="flex-grow-1">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <h6 class="fw-bold mb-1 {{ 'text-secondary' if het_cho else 'text-primary' }}">
                                    {{ kh.ten_khoa_hoc }}
                                </h6>
                                <span class="badge bg-light text-dark border font-monospace">{{ kh.ma_khoa_hoc }}</span>
                                <span class="badge bg-light text-secondary border">{{ kh.loai_khoa_hoc.ten_loai if kh.loai_khoa_hoc else '' }}</span>
                            </div>
                        </div>

                        <hr class="my-2 dashed">

                        <div class="small">
                            <div class="mb-1">
                                <span class="text-secondary fw-bold" style="min-width: 80px; display: inline-block;">Giáo viên:</span>
                                <span class="text-dark">{{ kh.giao_vien.ho_va_ten if kh.giao_vien else "Chưa có" }}</span>
                            </div>
                            <div class="mb-1">
                                <span class="text-secondary fw-bold" style="min-width: 80px; display: inline-block;">Thời gian:</span>
                                <span>{{ kh.ngay_bat_dau.strftime('%d/%m') }} - {{ kh.ngay_ket_thuc.strftime('%d/%m/%Y') }}</span>
                            </div>
                            <div class="mb-1">
                                <span class="text-secondary fw-bold" style="min-width: 80px; display: inline-block;">Học phí:</span>
                                <span class="fw-bold text-success font-monospace">{{ "{:,.0f}".format(kh.gia) if kh.gia else '0' }} ₫</span>
                            </div>

                            <div class="mt-2">
                                {% if het_cho %}
                                <div class="bg-secondary bg-opacity-10 text-secondary text-center rounded py-1 small fw-bold">
                                    <i class="bi bi-lock-fill me-1"></i>LỚP ĐÃ ĐẦY
                                </div>
                                {% else %}
                                <div class="d-flex align-items-center gap-2">
                                    <div class="progress flex-grow-1" style="height: 6px;">
                                        {% set percent = (kh.si_so_hien_tai / kh.si_so_toi_da * 100)|int %}
                                        <div class="progress-bar {{ 'bg-warning' if percent > 80 else 'bg-success' }}"
                                             style="width: {{ percent }}%"></div>
                                    </div>
                                    <span class="small fw-bold text-muted">{{ kh.si_so_hien_tai }}/{{ kh.si_so_toi_da }}</span>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </label>
        {% endfor %}
    </div>

    <div class="card border-0 shadow-sm bg-light sticky-bottom" style="z-index: 100; bottom: 0;">
        <div class="card-body">
            <div class="row g-2 align-items-center">
                <div class="col-12 col-md d-none d-md-block">
                    <div class="text-muted small fst-italic">
                        <i class="bi bi-info-circle me-1"></i> Tích chọn vào ô vuông đầu dòng để đăng ký.
                    </div>
                </div>
                <div class="col-6 col-md-auto">
                    <button type="reset" class="btn btn-white border w-100 text-secondary fw-medium hover-shadow">
                        <i class="bi bi-arrow-counterclockwise me-1"></i> Chọn lại
                    </button>
                </div>
                <div class="col-6 col-md-auto">
                    {% if current_user.is_authenticated %}
                    <button type="submit" class="btn btn-primary w-100 fw-bold shadow-sm"
                            onclick="return confirm('Xác nhận đăng ký các khóa học đã chọn?')">
                        <i class="bi bi-send-check-fill me-2"></i> Đăng ký ngay
                    </button>
                    {% else %}
                    <a href="{{ url_for('login', next=request.url) }}"
                       class="btn btn-warning w-100 fw-bold shadow-sm text-dark">
                        <i class="bi bi-box-arrow-in-right me-2"></i> Đăng nhập để đăng ký
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

</form>

{% else %}
<div class="text-center py-5">
    <div class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center mb-3 text-secondary"
         style="width: 80px; height: 80px;">
        <i class="bi bi-inbox fs-1 opacity-50"></i>
    </div>
    <h5 class="text-secondary fw-normal">Không tìm thấy khóa học nào phù hợp.</h5>
    <p class="text-muted small">Vui lòng thử thay đổi bộ lọc hoặc quay lại sau.</p>
</div>
{% endif %}
{% endblock %}