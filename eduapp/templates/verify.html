{% extends 'layout/base.html' %}

{% block title %}Xác thực tài khoản{% endblock %}

{% block card_body %}
<div class="row justify-content-center text-center">
    <div class="col-md-8 col-lg-6">
        <div class="mb-4 mt-2">
            <div class="bg-primary bg-opacity-10 text-primary rounded-circle d-inline-flex align-items-center justify-content-center mb-3"
                 style="width: 80px; height: 80px;">
                <i class="bi bi-shield-check fs-1"></i>
            </div>
            <h4 class="fw-bold text-dark">Xác thực Email</h4>
            <p class="text-muted small px-3">
                Mã OTP sẽ được gửi đến:
                <span class="fw-bold text-dark bg-light px-2 py-1 rounded border">{{ current_user.email }}</span>
                <a href="javascript:;" class="ms-1 text-primary" data-bs-toggle="modal" data-bs-target="#doiEmailModal"
                   title="Đổi email">
                    <i class="bi bi-pencil-square"></i>
                </a>
            </p>
        </div>

        <form method="post">
            <div class="mb-4">
                <input type="text" class="form-control text-center fw-bold text-primary fs-4" id="verify" name="verify"
                       placeholder="000000" maxlength="6" pattern="[0-9]{6}" required
                       style="letter-spacing: 0.5em; font-family: monospace; border: 2px solid #dee2e6;"
                       oninput="this.value = this.value.replace(/[^0-9]/g, '')" autofocus>
            </div>

            <div id="alert-box" class="alert d-flex align-items-center justify-content-center mb-4 shadow-sm"
                 style="min-height: 58px;">
                <i id="alert-icon" class="bi bi-info-circle me-2"></i>
                <p id="alert-text" class="mb-0 fw-bold small">Đang kiểm tra...</p>
            </div>

            <div class="d-grid gap-2">
                <button id="btn-submit" class="btn btn-primary btn-lg fw-bold shadow-sm" type="submit">Xác nhận kích
                    hoạt
                </button>
            </div>

            <div class="mt-4">
                <span class="text-muted small">Chưa nhận được mã?</span>
                <a id="btn-resend" href="{{ url_for('verify_page', action='resend') }}"
                   class="text-decoration-none small fw-bold ms-1">Gửi lại mã</a>
            </div>
        </form>
    </div>
</div>

<div class="modal fade" id="doiEmailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-light">
                <h5 class="modal-title fw-bold fs-6 text-uppercase text-muted">Cập nhật Email mới</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('update_email_verify') }}" method="POST">
                <div class="modal-body text-start">
                    <div class="mb-3">
                        <label for="new_email" class="form-label small fw-bold">Địa chỉ Email mới</label>
                        <input type="email" class="form-control" id="new_email" name="new_email"
                               required placeholder="vidu@gmail.com" value="{{ current_user.email }}">
                        <div class="form-text small">Hệ thống sẽ gửi mã xác nhận mới ngay sau khi bạn đổi email.</div>
                    </div>
                </div>
                <div class="modal-footer border-0 pt-0">
                    <button type="button" class="btn btn-light btn-sm fw-bold" data-bs-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-primary btn-sm fw-bold">Cập nhật & Gửi mã</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block javascript %}
<script>
    document.addEventListener("DOMContentLoaded", function() {
        const waitTime = {{ wait_time | default(0) }};
        const isBlocked = {{ 'true' if is_blocked else 'false' }};
        const blockTime = {{ block_time | default(0) }};

        const alertBox = document.getElementById("alert-box");
        const alertText = document.getElementById("alert-text");
        const alertIcon = document.getElementById("alert-icon");
        const btnSubmit = document.getElementById("btn-submit");
        const btnResend = document.getElementById("btn-resend");

        function updateUI(type, text, iconClass) {
            alertBox.className = `alert alert-${type} d-flex align-items-center justify-content-center mb-4 shadow-sm`;
            alertText.innerText = text;
            alertIcon.className = `bi ${iconClass} me-2`;
        }

        function startCountdown(seconds, prefix, type, endText, endType, endIcon, onEnd) {
            let current = seconds;
            updateUI(type, `${prefix} ${current}s`, "bi-clock-history");

            const timer = setInterval(() => {
                current--;
                if (current < 0) {
                    clearInterval(timer);
                    updateUI(endType, endText, endIcon);
                    if (onEnd) onEnd();
                    return;
                }
                alertText.innerText = `${prefix} ${current}s`;
            }, 1000);
        }

        if (isBlocked) {
            btnSubmit.disabled = true;
            btnResend.classList.add("disabled", "pointer-events-none");
            startCountdown(blockTime, "Bạn bị tạm chặn gửi mã. Thử lại sau:", "danger", "Đã hết thời gian chặn. Vui lòng tải lại trang.", "success", "bi-check-circle", () => {
                location.reload();
            });
        } else if (waitTime > 0) {
            startCountdown(waitTime, "Mã có hiệu lực trong:", "warning", "Mã xác nhận đã hết hiệu lực. Hãy gửi lại mã mới.", "secondary", "bi-exclamation-octagon", () => {
                btnSubmit.disabled = true;
            });
        } else {
            updateUI("info", "Vui lòng nhấn 'Gửi lại mã' để nhận mã xác minh mới.", "bi-envelope-exclamation");
            btnSubmit.disabled = true;
        }
    });
</script>
{% endblock %}