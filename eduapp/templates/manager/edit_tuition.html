{% extends 'layout/base.html' %}

{% block title %}Điều chỉnh học phí{% endblock %}

{% block card_header %}
<div class="p-3">
    <div class="row align-items-center">
        <div class="col-12 col-sm text-center text-sm-start mb-2 mb-sm-0">
            <span class="text-uppercase fw-bold h5 m-0 d-block d-sm-inline">
                {% if khoa_hoc %}
                    <i class="bi bi-cash-coin me-2"></i>ĐIỀU CHỈNH HỌC PHÍ (ĐƠN LẺ)
                {% else %}
                    <i class="bi bi-tags-fill me-2"></i>ĐIỀU CHỈNH HỌC PHÍ (HÀNG LOẠT)
                {% endif %}
            </span>
        </div>

        <div class="col-12 col-sm-auto">
            <a href="{{ url_for('manager_course_list') }}"
               class="btn btn-sm btn-outline-secondary w-100 d-block d-sm-inline-block">
                <i class="bi bi-arrow-left me-1"></i>Quay lại
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block card_body %}
<style>
    .no-spin::-webkit-inner-spin-button, .no-spin::-webkit-outer-spin-button {
        -webkit-appearance: none; margin: 0;
    }
    .course-avatar {
        width: 80px; height: 80px;
        background-color: #e9ecef;
        border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        margin: 0 auto;
    }
    .course-avatar.is-batch {
        background-color: #e0cffc;
        color: #6610f2;
        border: 2px dashed #6610f2;
    }
    .text-indigo { color: #6610f2; }
</style>

<div class="row justify-content-center mt-4">
    <div class="col-md-8 col-lg-6">
        <div class="card shadow-sm border-0 bg-light">
            <div class="card-body p-4 {% if not khoa_hoc %}border border-2 border-indigo-subtle rounded{% endif %}">

                <div class="text-center mb-4">
                    {% if khoa_hoc %}
                    <div class="course-avatar mb-2 bg-success-subtle">
                        <i class="bi bi-currency-dollar fs-1 text-success"></i>
                    </div>
                    <h5 class="fw-bold text-success">{{ khoa_hoc.ten_khoa_hoc }}</h5>
                    <span class="badge bg-secondary font-monospace">{{ khoa_hoc.ma_khoa_hoc }}</span>

                    <div class="mt-3 p-2 bg-white rounded border">
                        <small class="text-muted text-uppercase fw-bold" style="font-size: 0.7rem;">Học phí hiện
                            tại</small>
                        <div class="fs-4 fw-bold text-dark" id="display_current_price">
                            {{ "{:,.0f}".format(khoa_hoc.hoc_phi) }} ₫
                        </div>
                    </div>
                    {% else %}
                    <div class="course-avatar is-batch mb-3">
                        <i class="bi bi-percent fs-1"></i>
                    </div>
                    <h5 class="fw-bold text-indigo">GIẢM GIÁ TOÀN HỆ THỐNG</h5>
                    <span class="badge bg-warning text-dark border border-warning-subtle">
                            <i class="bi bi-exclamation-circle-fill me-1"></i>BATCH UPDATE
                        </span>
                    <p class="text-muted small mt-2 fst-italic">
                        Áp dụng mức giảm giá theo phần trăm (%) cho<br>
                        <strong>tất cả khóa học đang hoạt động</strong>.
                    </p>
                    {% endif %}
                </div>

                <form method="post" id="tuitionForm">
                    <div class="mb-3" {% if not khoa_hoc %}style="display:none" {% endif %}>
                        <label class="form-label fw-bold text-secondary small">CHỌN PHƯƠNG THỨC:</label>
                        <select class="form-select" id="method_select" onchange="toggleMethod()">
                            <option value="manual">Nhập giá thủ công (VNĐ)</option>
                            <option value="percent">Giảm giá theo phần trăm (%)</option>
                        </select>
                    </div>

                    {% if khoa_hoc %}
                    <div id="manual_input_group" class="mb-3">
                        <label class="form-label">Học phí mới (VNĐ)</label>
                        <div class="input-group">
                            <input type="text" class="form-control fw-bold fs-5 text-primary"
                                   id="manual_price_display"
                                   placeholder="Nhập số tiền..."
                                   oninput="handleManualInput()">
                            <span class="input-group-text fw-bold">₫</span>
                        </div>
                    </div>
                    {% endif %}

                    <div id="percent_input_group" class="mb-3" style="display: none;">
                        <label class="form-label">Chọn mức giảm giá</label>
                        <div class="row g-2 align-items-center">
                            <div class="col-8">
                                <select class="form-select fw-bold text-danger" id="percent_select"
                                        onchange="handlePercentInput()">
                                    <option value="0">Không giảm (0%)</option>
                                    <option value="5">Giảm 5%</option>
                                    <option value="10">Giảm 10%</option>
                                    <option value="15">Giảm 15%</option>
                                    <option value="20">Giảm 20%</option>
                                    <option value="30">Giảm 30%</option>
                                    <option value="50">Giảm 50%</option>
                                </select>
                            </div>
                            <div class="col-4">
                                <div class="input-group">
                                    <input type="number" class="form-control fw-bold text-danger"
                                           id="percent_manual" placeholder="Tự nhập" min="0" max="100"
                                           oninput="handlePercentManual()">
                                    <span class="input-group-text">%</span>
                                </div>
                            </div>
                        </div>

                        {% if khoa_hoc %}
                        <div class="form-text mt-2">
                            Sau khi giảm: <span id="percent_result" class="fw-bold text-success fs-6">--- ₫</span>
                        </div>
                        {% else %}
                        <div class="form-text mt-2 text-indigo">
                            * Mức giảm này sẽ được áp dụng cho giá gốc của từng lớp.
                        </div>
                        {% endif %}
                    </div>

                    <input type="hidden" name="hoc_phi_moi" id="final_price_value">
                    <input type="hidden" name="percent_value" id="percent_value_hidden">

                    <hr>
                    <div class="d-grid">
                        {% if khoa_hoc %}
                        <button type="submit" class="btn btn-success fw-bold py-2 shadow-sm">
                            <i class="bi bi-check-lg me-2"></i>Lưu học phí mới
                        </button>
                        {% else %}
                        <button type="submit" class="btn btn-warning fw-bold py-2 shadow-sm text-dark"
                                onclick="return confirm('Bạn có chắc chắn muốn giảm giá cho TOÀN BỘ khóa học không?')">
                            <i class="bi bi-tags-fill me-2"></i>Áp dụng cho tất cả
                        </button>
                        {% endif %}
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascript %}
<script>
    const isSingleMode = {{ 'true' if khoa_hoc else 'false' }};
    const currentPrice = {{ khoa_hoc.hoc_phi if khoa_hoc else 0 }};
    const vnCurrency = new Intl.NumberFormat('vi-VN');

    function toggleMethod() {
        const method = document.getElementById('method_select').value;
        const manualGroup = document.getElementById('manual_input_group');
        const percentGroup = document.getElementById('percent_input_group');

        if (!isSingleMode) {
            if (manualGroup) manualGroup.style.display = 'none';
            percentGroup.style.display = 'block';
            return;
        }

        const manualInput = document.getElementById('manual_price_display');
        if (method === 'manual') {
            manualGroup.style.display = 'block';
            percentGroup.style.display = 'none';
            manualInput.value = vnCurrency.format(currentPrice);
            document.getElementById('final_price_value').value = currentPrice;
        } else {
            manualGroup.style.display = 'none';
            percentGroup.style.display = 'block';
            document.getElementById('percent_select').value = 0;
            handlePercentInput();
        }
    }

    function handleManualInput() {
        if (!isSingleMode) return;
        const input = document.getElementById('manual_price_display');
        let rawValue = input.value.replace(/\D/g, '');
        if (rawValue === '') {
            document.getElementById('final_price_value').value = 0;
            return;
        }
        const numericVal = parseInt(rawValue);
        input.value = vnCurrency.format(numericVal);
        document.getElementById('final_price_value').value = numericVal;
    }

    function handlePercentInput() {
        const percent = parseInt(document.getElementById('percent_select').value) || 0;
        document.getElementById('percent_manual').value = '';
        applyPercentLogic(percent);
    }

    function handlePercentManual() {
        let percent = parseFloat(document.getElementById('percent_manual').value);
        if (isNaN(percent)) percent = 0;
        if (percent > 100) percent = 100;
        document.getElementById('percent_select').value = 0;
        applyPercentLogic(percent);
    }

    function applyPercentLogic(percent) {
        document.getElementById('percent_value_hidden').value = percent;
        if (isSingleMode) {
            const discountAmount = currentPrice * (percent / 100);
            const newPrice = currentPrice - discountAmount;
            document.getElementById('percent_result').innerText = vnCurrency.format(Math.round(newPrice)) + " ₫";
            document.getElementById('final_price_value').value = Math.round(newPrice);
        }
    }

    document.addEventListener("DOMContentLoaded", function() {
        toggleMethod();
    });
</script>
{% endblock %}