{% extends 'layout/base.html' %}

{% block title %}Thống kê - Báo cáo{% endblock %}

{% block card_header %}
<div class="p-3">
    <div class="row align-items-center">
        <div class="col-12 col-sm text-sm-start mb-2 mb-sm-0">
            <span class="text-uppercase fw-bold m-0 d-block d-sm-inline">
                <i class="bi bi-bar-chart-fill me-2"></i>Thống kê - Báo cáo quản trị
            </span>
        </div>
        <div class="col-12 col-sm-auto">
            <small><i class="bi bi-calendar3 me-1"></i>Ngày: <span id="current-date-display"></span></small>
        </div>
    </div>
</div>
{% endblock %}

{% block card_body %}
<div class="row mb-4">
    <div class="col-xl-6 col-md-6 mb-3 mb-md-4">
        <div class="card card-stat border-left-primary shadow h-100 py-2 border-0 bg-white">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Tổng Doanh Thu (<span
                                id="displayYear">2025</span>)
                        </div>
                        <div class="h2 mb-0 font-weight-bold text-dark" id="displayTotalRevenue">
                            {{ "{:,.0f}".format(tong_doanh_thu_nam).replace(',', '.') }} <small class="text-muted"
                                                                                                style="font-size: 0.6em;">VNĐ</small>
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="bi bi-cash-stack fs-1 text-primary opacity-25"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-6 col-md-6 mb-3 mb-md-4">
        <div class="card card-stat border-left-success shadow h-100 py-2 border-0 bg-white">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Tổng Lượt Học Viên</div>
                        <div class="h2 mb-0 font-weight-bold text-dark">
                            {{ tong_hoc_vien_he_thong }} <small class="text-muted" style="font-size: 0.6em;">Học
                            viên</small>
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="bi bi-people-fill fs-1 text-success opacity-25"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card shadow mb-4 border-0">
    <div class="card-header py-3 bg-white d-flex flex-column flex-md-row align-items-center justify-content-between border-0">
        <h6 class="m-0 font-weight-bold text-dark text-uppercase"><i class="bi bi-graph-up-arrow me-2"></i>Doanh thu
            theo tháng</h6>

        <div class="d-flex flex-wrap align-items-center justify-content-center gap-2 mt-2 mt-md-0">
            <select id="yearFilter" class="form-select form-select-sm shadow-none w-auto">
                {% for nam in ds_nam %}
                <option value="{{ nam }}" {% if nam== current_year %}selected{% endif %}>Năm {{ nam }}</option>
                {% endfor %}
            </select>
            <button onclick="printRevenueReport()" class="btn btn-sm btn-outline-success">
                <i class="bi bi-printer me-1"></i>In báo cáo năm
            </button>
        </div>
    </div>
    <div class="card-body">
        <div style="position: relative; height: var(--header-stats); width: 100%;">
            <canvas id="revenueChart"></canvas>
        </div>
    </div>
</div>

<div class="card shadow mb-4 border-0">
    <div class="card-header py-3 bg-white border-bottom-0 d-flex flex-column flex-md-row align-items-center justify-content-between">
        <h6 class="m-0 font-weight-bold text-dark text-uppercase mb-2 mb-md-0"><i class="bi bi-pie-chart-fill me-2"></i>Hiệu
            quả đào tạo</h6>

        <div class="d-flex flex-wrap align-items-center justify-content-center gap-2">
            <div class="input-group input-group-sm" style="max-width: 250px;">
                <span class="input-group-text bg-light border-end-0"><i class="bi bi-search"></i></span>
                <select id="courseFilter" class="form-select border-start-0 shadow-none fw-bold text-primary"
                        onchange="updateDetailCharts()">
                    {% for item in du_lieu_khoa_hoc_full %}
                    <option value="{{ loop.index0 }}">{{ item.ten_khoa_hoc }}</option>
                    {% endfor %}
                </select>
            </div>
            <button onclick="printCourseDetailReport()" class="btn btn-sm btn-outline-primary whitespace-nowrap">
                <i class="bi bi-printer me-1"></i>In chi tiết
            </button>
        </div>
    </div>

    <div class="card-body pt-0">
        <div class="row">
            <div class="col-lg-6 mb-4">
                <div class="card h-100 border-0 bg-light">
                    <div class="card-body">
                        <h6 class="text-center font-weight-bold text-secondary mb-3 text-uppercase small">Quy mô lớp
                            học</h6>
                        <div style="height: var(--header-stats-hv); position: relative;">
                            <canvas id="studentCountChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6 mb-4">
                <div class="card h-100 border-0 bg-light">
                    <div class="card-body">
                        <h6 class="text-center font-weight-bold text-secondary mb-3 text-uppercase small">Tỷ lệ hoàn
                            thành</h6>
                        <div style="height: var(--header-stats-hv); position: relative;">
                            <canvas id="passRateChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascript %}
<script>
    Chart.defaults.font.family = "'Nunito', sans-serif";
    Chart.defaults.color = '#858796';

    document.getElementById('current-date-display').innerText = new Date().toLocaleDateString('vi-VN');

    const formatCurrency = (value) => new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(value);
    const masterDataCourses = {{ du_lieu_khoa_hoc_full | tojson }};
    const dataDoanhThuInit = {{ data_doanh_thu | tojson }};

    const ctxRevenue = document.getElementById('revenueChart').getContext('2d');
    let revenueChartObj = null;

    function initRevenueChart(data) {
        let gradient = ctxRevenue.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, 'rgba(78, 115, 223, 0.1)');
        gradient.addColorStop(1, 'rgba(78, 115, 223, 0.0)');

        revenueChartObj = new Chart(ctxRevenue, {
            type: 'line',
            data: {
                labels: ["T1", "T2", "T3", "T4", "T5", "T6", "T7", "T8", "T9", "T10", "T11", "T12"],
                datasets: [{
                    label: 'Doanh thu',
                    data: data,
                    backgroundColor: gradient,
                    borderColor: '#4e73df',
                    pointBackgroundColor: '#fff',
                    pointBorderColor: '#4e73df',
                    pointRadius: 4,
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    // SỬA TRỤC Y: LUÔN HIỂN THỊ PHẦN DƯƠNG
                    y: {
                        beginAtZero: true,
                        min: 0,
                        ticks: {
                            callback: v => v >= 1000000 ? (v/1000000).toFixed(0) + ' Tr' : v
                        }
                    }
                }
            }
        });
    }

    // --- HÀM IN DOANH THU ---
    function printRevenueReport() {
        const year = document.getElementById('yearFilter').value;
        const total = document.getElementById('displayTotalRevenue').innerText;
        const chartImg = revenueChartObj.toBase64Image();
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <html><head><title>Báo cáo doanh thu ${year}</title>
            <style>
                body { font-family: sans-serif; padding: 40px; }
                .text-center { text-align: center; }
                .header { border-bottom: 2px solid #4e73df; margin-bottom: 30px; padding-bottom: 10px; }
                .chart-box { border: 1px solid #ddd; padding: 20px; margin: 20px 0; }
                .total { font-size: 24px; color: #e74a3b; font-weight: bold; text-align: right; }
            </style></head>
            <body>
                <div class="header text-center"><h2>BÁO CÁO DOANH THU NĂM ${year}</h2></div>
                <p>Người xuất: {{ current_user.ho_va_ten }} | Ngày: ${new Date().toLocaleDateString('vi-VN')}</p>
                <div class="chart-box text-center"><img src="${chartImg}" style="width: 100%;"></div>
                <p class="total">TỔNG CỘNG: ${total}</p>
                <script>window.onload = function() { window.print(); window.close(); }<\/script>
            </body></html>`);
        printWindow.document.close();
    }

    // --- HÀM IN CHI TIẾT KHÓA HỌC ---
    function printCourseDetailReport() {
        const idx = document.getElementById('courseFilter').value;
        const course = masterDataCourses[idx];
        const stuImg = studentChart.toBase64Image();
        const passImg = passFailChart.toBase64Image();
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <html><head><title>Báo cáo - ${course.ten_khoa_hoc}</title>
            <style>
                body { font-family: sans-serif; padding: 40px; }
                .header { border-bottom: 2px solid #1cc88a; margin-bottom: 30px; }
                .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
                .card { border: 1px solid #ddd; padding: 15px; text-align: center; }
                table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
            </style></head>
            <body>
                <div class="header"><h2>BÁO CÁO CHI TIẾT KHÓA HỌC</h2><h3>${course.ten_khoa_hoc}</h3></div>
                <div class="grid">
                    <div class="card"><b>Sĩ số</b><br><img src="${stuImg}" style="width: 100%;"></div>
                    <div class="card"><b>Tỷ lệ đạt</b><br><img src="${passImg}" style="width: 100%;"></div>
                </div>
                <table>
                    <thead><tr><th>Đạt (%)</th><th>Rớt (%)</th><th>Chưa KQ (%)</th></tr></thead>
                    <tbody><tr><td>${course.ty_le_dat}%</td><td>${course.ty_le_rot}%</td><td>${course.ty_le_chua_kq}%</td></tr></tbody>
                </table>
                <script>window.onload = function() { window.print(); window.close(); }<\/script>
            </body></html>`);
        printWindow.document.close();
    }

    let studentChart = null, passFailChart = null;
    function renderDetailCharts(course) {
        const ctxStu = document.getElementById('studentCountChart').getContext('2d');
        if (studentChart) studentChart.destroy();
        studentChart = new Chart(ctxStu, {
            type: 'bar',
            data: { labels: ['Học viên'], datasets: [{ data: [course.so_luong_hv], backgroundColor: '#36b9cc' }] },
            options: { maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });

        const ctxPass = document.getElementById('passRateChart').getContext('2d');
        if (passFailChart) passFailChart.destroy();
        passFailChart = new Chart(ctxPass, {
            type: 'doughnut',
            data: {
                labels: ['Đạt', 'Rớt', 'Chưa KQ'],
                datasets: [{ data: [course.ty_le_dat, course.ty_le_rot, course.ty_le_chua_kq], backgroundColor: ['#1cc88a', '#e74a3b', '#e3e6f0'] }]
            },
            options: { maintainAspectRatio: false, cutout: '70%' }
        });
    }

    function updateDetailCharts() {
        const idx = document.getElementById('courseFilter').value;
        if(masterDataCourses[idx]) renderDetailCharts(masterDataCourses[idx]);
    }

    document.addEventListener('DOMContentLoaded', () => {
        initRevenueChart(dataDoanhThuInit);
        if (masterDataCourses.length > 0) renderDetailCharts(masterDataCourses[0]);
    });
</script>
{% endblock %}