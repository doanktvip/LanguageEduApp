{% extends 'layout/base.html' %}

{% block title %}{{ role_title }}{% endblock %}

{% block card_header %}
<div class="p-3 d-flex justify-content-between align-items-center">
    <span class="text-uppercase">
        <i class="bi bi-person-plus-fill me-2"></i>{{ role_title }}
    </span>
    <a href="{{ back_url }}" class="btn btn-sm btn-outline-secondary">
        <i class="bi bi-arrow-left me-1"></i>Quay lại
    </a>
</div>
{% endblock %}

{% block card_body %}
<style>
    input { background-image: none !important; }
</style>
<div class="row justify-content-center mt-4">
    <div class="col-md-10 col-lg-8">
        {% if msg %}
        <div class="alert alert-success shadow-sm border-0 mb-4 p-4 text-center">
            <i class="bi bi-check-circle-fill fs-1 text-success d-block mb-3"></i>
            <h5 class="fw-bold text-success">{{ msg }}</h5>
            <p class="text-muted small">Tài khoản đã được khởi tạo và sẵn sàng sử dụng.</p>
            <div class="mt-4 d-flex justify-content-center gap-2">
                <a href="{{ back_url }}" class="btn btn-success fw-bold shadow-sm">
                    <i class="bi bi-arrow-return-left me-1"></i> Quay về danh sách
                </a>
                <a href="{{ url_for('manager_add_user', role_type=role_name) }}"
                   class="btn btn-outline-success fw-bold shadow-sm">
                    <i class="bi bi-plus-lg me-1"></i> Thêm người khác
                </a>
            </div>
        </div>
        {% else %}
        <div class="text-center mb-4 mt-2">
            <p class="text-muted small">Điền thông tin bên dưới để tạo tài khoản mới.</p>
        </div>
        <div class="position-relative mb-5 mx-4">
            <div class="progress" style="height: 2px;">
                <div class="progress-bar bg-warning" role="progressbar"
                     style="width: {{ '0%' if not show_step2 else '100%' }}; transition: width 0.5s ease;"></div>
            </div>
            <button type="button"
                    class="position-absolute top-0 start-0 translate-middle btn btn-sm rounded-pill {{ 'btn-warning text-dark' if not show_step2 else 'btn-success text-white' }} fw-bold shadow-sm"
                    style="width: 2rem; height: 2rem;">
                {% if show_step2 %}<i class="bi bi-check"></i>{% else %}1{% endif %}
            </button>
            <button type="button"
                    class="position-absolute top-0 start-100 translate-middle btn btn-sm rounded-pill {{ 'btn-warning text-dark' if show_step2 else 'btn-secondary text-white' }} fw-bold shadow-sm"
                    style="width: 2rem; height: 2rem;">
                2
            </button>
        </div>
        {% if err_msg %}
        <div class="alert alert-danger d-flex align-items-center border-0 shadow-sm mb-4" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2 fs-5"></i>
            <div>{{ err_msg }}</div>
        </div>
        {% endif %}
        <div class="collapse {% if not show_step2 %}show{% endif %}" id="step1">
            <form class="was-validated" method="post">
                <input type="hidden" name="step" value="1">
                <h6 class="text-uppercase text-muted small fw-bold mb-3">
                    <i class="bi bi-shield-lock me-1"></i>Thông tin đăng nhập
                </h6>
                <div class="form-floating mb-3">
                    <input type="text" class="form-control" id="name" name="name"
                           placeholder="Họ và tên" required value="{{ data.get('name', '') }}">
                    <label for="name">Họ và tên hiển thị</label>
                </div>
                <div class="form-floating mb-3">
                    <input type="text" class="form-control" id="username" name="username"
                           placeholder="Tên đăng nhập" required value="{{ data.get('username', '') }}">
                    <label for="username">Tên đăng nhập</label>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-floating mb-3">
                            <input type="password" class="form-control" id="password" name="password"
                                   placeholder="Mật khẩu" required minlength="6"
                                   value="{{ data.get('password', '') }}">
                            <label for="password">Mật khẩu</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-floating mb-3">
                            <input type="password" class="form-control" id="re_enter_password" name="re_enter_password"
                                   placeholder="Nhập lại" required
                                   value="{{ data.get('re_enter_password', '') }}">
                            <label for="re_enter_password">Xác nhận mật khẩu</label>
                        </div>
                    </div>
                </div>
                <div class="d-flex justify-content-end mt-4">
                    <button class="btn btn-primary px-4 fw-bold shadow-sm" type="submit">
                        Tiếp theo <i class="bi bi-arrow-right ms-2"></i>
                    </button>
                </div>
            </form>
        </div>
        <div class="collapse {% if show_step2 %}show{% endif %}" id="step2">
            <form class="was-validated" method="post" enctype="multipart/form-data">
                <input type="hidden" name="step" value="2">
                <h6 class="text-uppercase text-muted small fw-bold mb-3">
                    <i class="bi bi-person-badge me-1"></i>Thông tin cá nhân
                </h6>
                <div class="text-center mb-4">
                    <div class="position-relative d-inline-block">
                        <img id="registerPreview"
                             src="https://res.cloudinary.com/db4bjqp4f/image/upload/v1765436438/shtnr60mecp057e2uctk.jpg"
                             class="rounded-circle shadow-sm border border-3 border-light bg-white"
                             style="width: 120px; height: 120px; object-fit: cover;">
                        <label for="image"
                               class="position-absolute bottom-0 end-0 bg-primary text-white rounded-circle p-2 shadow"
                               style="cursor: pointer;">
                            <i class="bi bi-camera-fill small"></i>
                        </label>
                    </div>
                    <input type="file" class="d-none" id="image" name="image" accept=".png,.jpg,.jpeg">
                    <div class="small text-muted mt-1 fst-italic">Ảnh đại diện</div>
                </div>
                <div class="row">
                    <div class="col-md-7">
                        <div class="form-floating mb-3">
                            <input type="email" class="form-control" id="email" name="email"
                                   placeholder="Email" required value="{{ data.get('email', '') }}">
                            <label for="email">Địa chỉ Email</label>
                        </div>
                    </div>
                    <div class="col-md-5">
                        <div class="form-floating mb-3">
                            <input type="tel" class="form-control" id="phone_number" name="phone_number"
                                   placeholder="SĐT" required pattern="[0-9]{10}"
                                   value="{{ data.get('phone_number', '') }}">
                            <label for="phone_number">Số điện thoại</label>
                        </div>
                    </div>
                </div>
                {% if role_name == 'HOC_VIEN' %}
                <div class="form-floating mb-3">
                    <input type="date" class="form-control" id="dob" name="dob" required
                           value="{{ data.get('dob', '') }}">
                    <label for="dob">Ngày sinh</label>
                </div>
                {% endif %}
                {% if role_name == 'GIAO_VIEN' %}
                <div class="form-floating mb-3">
                    <input type="number" class="form-control" id="exp" name="exp" required
                           value="{{ data.get('exp', '') }}">
                    <label for="exp">Ngày kinh nghiệm</label>
                </div>
                {% endif %}
                <div class="d-flex justify-content-between mt-4 align-items-center">
                    <button class="btn btn-light text-secondary border fw-medium" type="submit" name="back_to_step1"
                            value="1" formnovalidate>
                        <i class="bi bi-arrow-left me-2"></i>Quay lại
                    </button>
                    <button class="btn btn-primary px-4 fw-bold shadow-sm" type="submit">
                        <i class="bi bi-check-lg me-2"></i>Hoàn tất
                    </button>
                </div>
            </form>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block javascript %}
<script>
    document.addEventListener("DOMContentLoaded", function() {
        setupImagePreview("image", "registerPreview");
    });
</script>
{% endblock %}