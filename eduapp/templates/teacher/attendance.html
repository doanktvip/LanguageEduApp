{% extends 'layout/base.html' %}

{% block title %} Điểm danh lớp học {% endblock %}

{% block card_header %}
<div class="p-3 bg-white border-bottom">
    <div class="row align-items-center">
        <div class="col-12 col-sm text-center text-sm-start mb-2 mb-sm-0">
            <h5 class="text-uppercase fw-bold m-0 text-primary">
                <i class="bi bi-calendar-check-fill me-2"></i>ĐIỂM DANH LỚP HỌC
            </h5>
        </div>
        {% if course %}
        <div class="col-12 col-sm-auto text-center">
            <span class="badge bg-light text-dark border px-3 py-2">
                Sĩ số: <strong>{{ course.si_so_hien_tai }}</strong>/{{ course.si_so_toi_da }}
            </span>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block card_body %}
<div class="bg-light p-3 rounded mb-4 border shadow-sm">
    <form action="/attendance" method="GET" id="form-select-course" class="row g-3">
        <div class="col-12 col-lg-6">
            <div class="input-group">
                <span class="input-group-text bg-white text-primary border-end-0"><i class="bi bi-search"></i></span>
                <select name="course_id" class="form-select fw-bold border-start-0 shadow-none"
                        onchange="this.form.submit()">
                    {% for kh in ds_khoa_hoc %}
                    <option value="{{ kh.ma_khoa_hoc }}" {{
                    'selected' if course and kh.ma_khoa_hoc == course.ma_khoa_hoc else '' }}>
                    {{ kh.ten_khoa_hoc }}
                    </option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="col-12 col-lg-6 d-flex align-items-center justify-content-lg-end">
            {% if course %}
            <div class="text-muted small fw-bold">
                <i class="bi bi-calendar-event text-danger"></i> Buổi đang chọn:
                <span class="text-danger fw-bold">
                    {% for s in sessions %}
                        {% if s.id == target_session_id %}
                            {{ s.display_date }} ({{ s.shift_name }})
                        {% endif %}
                    {% endfor %}
                </span>
            </div>
            {% endif %}
        </div>
    </form>
</div>

{% if course %}
{% if student_rows and student_rows|length > 0 %}
<form action="/attendance" method="POST" id="attendanceForm">
    <input type="hidden" name="course_id" value="{{ course.ma_khoa_hoc }}">

    <div id="mainTableContainer" class="table-responsive d-none d-md-block shadow-sm border bg-white mb-4"
         style="max-height: 65vh;">
        <table class="table table-bordered table-hover mb-0 align-middle text-center" style="min-width: 1000px;">
            <thead>
            <tr class="small fw-bold">
                <th class="text-start ps-3 bg-white shadow-sm"
                    style="position: sticky; left: 0; z-index: 1010; border-right: 2px solid #dee2e6;">
                    HỌC VIÊN
                </th>
                {% for sess in sessions %}
                {% set is_target = (sess.id == target_session_id) %}
                <th id="col_{{ sess.id }}"
                    class="{{ 'bg-primary text-white border-primary' if is_target else 'bg-white text-secondary' }}"
                    style="min-width: 100px;">
                    <div style="font-size: {{ '1rem' if is_target else '0.85rem' }};">
                        {{ sess.display_date }}
                    </div>
                    <div class="badge {{ 'bg-white text-primary' if is_target else 'bg-light text-muted border' }} fw-normal mt-1">
                        {{ sess.shift_name }}
                    </div>
                </th>
                {% endfor %}
                <th class="bg-white fw-bold shadow-sm"
                    style="position: sticky; right: 0; z-index: 1010; border-left: 2px solid #dee2e6;">%
                </th>
            </tr>
            </thead>
            <tbody>
            {% for row in student_rows %}
            <tr>
                <td class="text-start ps-3 bg-white shadow-sm"
                    style="position: sticky; left: 0; z-index: 1010; border-right: 2px solid #dee2e6;">
                    <div class="fw-bold text-dark text-truncate" style="max-width: 220px;">{{ row.info.ho_va_ten }}
                    </div>
                    <div class="small text-muted font-monospace">{{ row.info.ma_nguoi_dung }}</div>
                </td>

                {% for cell in row.cells %}
                {% set input_name = 'att_' ~ row.info.ma_nguoi_dung ~ '_' ~ cell.session_id %}
                {% set is_target = (cell.session_id == target_session_id) %}
                {% set status_val = cell.status | int %}

                <td class="p-2 {{ 'bg-primary bg-opacity-10 border-primary border-opacity-25' if is_target else '' }}">

                    {% if cell.is_editable %}
                    <div class="btn-group w-100 bg-white shadow-sm rounded js-attendance-group" role="group">

                        <input type="radio" class="btn-check" name="{{ input_name }}" id="c_{{ input_name }}" value="1"
                               {{ 'checked' if status_val == 1 }}>
                        <label class="btn {{ 'btn-success text-white' if status_val == 1 else 'btn-outline-success' }} border-0 py-2 fw-bold"
                               for="c_{{ input_name }}" title="Có mặt" data-type="1">
                            <i class="bi bi-check-lg"></i>
                        </label>

                        <input type="radio" class="btn-check" name="{{ input_name }}" id="p_{{ input_name }}" value="2"
                               {{ 'checked' if status_val == 2 }}>
                        <label class="btn {{ 'btn-warning text-dark' if status_val == 2 else 'btn-outline-warning text-dark' }} border-0 fw-bold py-2"
                               for="p_{{ input_name }}" title="Có phép" data-type="2">P</label>

                        <input type="radio" class="btn-check" name="{{ input_name }}" id="v_{{ input_name }}" value="3"
                               {{ 'checked' if status_val == 3 }}>
                        <label class="btn {{ 'btn-danger text-white' if status_val == 3 else 'btn-outline-danger' }} border-0 py-2 fw-bold"
                               for="v_{{ input_name }}" title="Vắng" data-type="3">
                            <i class="bi bi-x-lg"></i>
                        </label>
                    </div>

                    {% else %}
                    {% if status_val > 0 %}
                    <div class="text-muted opacity-75">
                        {% if status_val == 1 %} <i class="bi bi-check-lg text-success fs-5"></i>
                        {% elif status_val == 2 %} <span class="fw-bold text-warning">P</span>
                        {% elif status_val == 3 %} <i class="bi bi-x-lg text-danger fs-5"></i>
                        {% endif %}
                    </div>
                    {% else %}
                    <span class="text-muted opacity-25 small fw-bold">-</span>
                    {% endif %}
                    {% endif %}
                </td>
                {% endfor %}

                <td class="bg-white fw-bold shadow-sm"
                    style="position: sticky; right: 0; z-index: 1010; border-left: 2px solid #dee2e6;">
                    <span class="{{ 'text-success' if row.percent >= 80 else 'text-danger' }}">{{ row.percent }}%</span>
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="d-md-none pb-4">
        <div class="alert alert-primary shadow-sm border-0 d-flex align-items-center mb-3">
            <i class="bi bi-calendar-event fs-1 me-3"></i>
            <div>
                <div class="small text-uppercase fw-bold opacity-75">Điểm danh hôm nay</div>
                <div class="fs-5 fw-bold">
                    {% for s in sessions %}
                    {% if s.id == target_session_id %}
                    {{ s.display_date }} ({{ s.shift_name }})
                    {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>

        {% for row in student_rows %}
        <div class="card mb-3 shadow-sm border-0">
            <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="fw-bold text-dark mb-0">{{ row.info.ho_va_ten }}</h6>
                    <small class="text-muted font-monospace">{{ row.info.ma_nguoi_dung }}</small>
                </div>
                <span class="badge {{ 'bg-success' if row.percent >= 80 else 'bg-danger' }}">{{ row.percent }}%</span>
            </div>
            <div class="card-body bg-light bg-opacity-25">
                {% for cell in row.cells %}
                {% if cell.session_id == target_session_id and cell.is_editable %}
                {% set status_val = cell.status | int %}
                {% set input_name = 'att_' ~ row.info.ma_nguoi_dung ~ '_' ~ cell.session_id %}

                <div class="bg-white p-3 rounded border shadow-sm">
                    <div class="btn-group w-100 js-attendance-group" role="group">
                        <input type="radio" class="btn-check" name="{{ input_name }}" id="m_c_{{ input_name }}"
                               value="1" {{ 'checked' if status_val == 1 }}>
                        <label class="btn {{ 'btn-success text-white' if status_val == 1 else 'btn-outline-success' }} py-2"
                               for="m_c_{{ input_name }}" data-type="1">Có mặt</label>

                        <input type="radio" class="btn-check" name="{{ input_name }}" id="m_p_{{ input_name }}"
                               value="2" {{ 'checked' if status_val == 2 }}>
                        <label class="btn {{ 'btn-warning text-dark' if status_val == 2 else 'btn-outline-warning text-dark' }} py-2"
                               for="m_p_{{ input_name }}" data-type="2">Phép</label>

                        <input type="radio" class="btn-check" name="{{ input_name }}" id="m_v_{{ input_name }}"
                               value="3" {{ 'checked' if status_val == 3 }}>
                        <label class="btn {{ 'btn-danger text-white' if status_val == 3 else 'btn-outline-danger' }} py-2"
                               for="m_v_{{ input_name }}" data-type="3">Vắng</label>
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>

    {% set ns = namespace(show_save_btn=false) %}
    {% for s in sessions %}
    {% if s.is_editable %}
    {% set ns.show_save_btn = true %}
    {% endif %}
    {% endfor %}

    {% if ns.show_save_btn %}
    <div class="text-center mt-2 mb-4">
        <button type="submit" class="btn btn-primary btn-lg px-5 fw-bold shadow">
            <i class="bi bi-box-arrow-in-down me-2"></i>LƯU ĐIỂM DANH
        </button>
    </div>
    {% else %}
    <div class="text-center mt-4 mb-4 text-muted small">
        <i class="bi bi-lock-fill"></i> Hiện tại không có buổi học nào cần điểm danh.
    </div>
    {% endif %}

</form>
{% else %}
<div class="text-center py-5">
    <div class="text-muted opacity-50 display-1"><i class="bi bi-people"></i></div>
    <h5 class="text-muted mt-3">Lớp này chưa có học viên.</h5>
</div>
{% endif %}
{% else %}
<div class="alert alert-info text-center shadow-sm mt-4">
    Vui lòng chọn khóa học để bắt đầu.
</div>
{% endif %}
{% endblock %}

{% block javascript %}
<script>
    document.addEventListener("DOMContentLoaded", function() {
        // 1. Logic cuộn bảng (Giữ nguyên)
        const container = document.getElementById('mainTableContainer');
        const targetId = "col_{{ target_session_id }}";
        const targetEl = document.getElementById(targetId);

        if (container && targetEl) {
            const offset = targetEl.offsetLeft - 260;
            setTimeout(() => {
                container.scrollTo({ left: offset, behavior: 'smooth' });
            }, 300);
        }

        // 2. LOGIC JAVASCRIPT XỬ LÝ CHUYỂN MÀU NÚT BẤM (MỚI)
        // Tìm tất cả các group nút điểm danh
        const groups = document.querySelectorAll('.js-attendance-group');

        groups.forEach(group => {
            const radios = group.querySelectorAll('input[type="radio"]');

            radios.forEach(radio => {
                radio.addEventListener('change', function() {
                    // Khi một nút được chọn, reset giao diện cả nhóm trước
                    updateVisualsForGroup(group);
                });
            });
        });

        function updateVisualsForGroup(group) {
            const labels = group.querySelectorAll('label');
            const radios = group.querySelectorAll('input[type="radio"]');

            radios.forEach((radio, index) => {
                const label = labels[index];
                const type = label.getAttribute('data-type'); // 1: Có mặt, 2: Phép, 3: Vắng

                if (radio.checked) {
                    if (type == '1') {
                        label.className = "btn btn-success text-white border-0 py-2 fw-bold";
                    } else if (type == '2') {
                        label.className = "btn btn-warning text-dark border-0 fw-bold py-2";
                    } else if (type == '3') {
                        label.className = "btn btn-danger text-white border-0 py-2 fw-bold";
                    }
                } else {
                    if (type == '1') {
                        label.className = "btn btn-outline-success border-0 py-2 fw-bold";
                    } else if (type == '2') {
                        label.className = "btn btn-outline-warning text-dark border-0 fw-bold py-2";
                    } else if (type == '3') {
                        label.className = "btn btn-outline-danger border-0 py-2 fw-bold";
                    }
                }
            });
        }
    });
</script>
{% endblock %}