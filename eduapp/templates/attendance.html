{% extends 'layout/base.html' %}

{% block title %} Điểm danh lớp học {% endblock %}

{% block card_header %}
<div class="d-flex justify-content-between align-items-center p-3 border-bottom">
    <div class="d-flex align-items-center gap-2"><i class="bi bi-calendar-check-fill me-2"></i>Điểm danh</div>
    {% if course %}
    <span class="badge bg-light text-dark border">
        Sĩ số: <strong>{{ course.si_so_hien_tai }}</strong>/{{ course.si_so_toi_da }}
    </span>
    {% endif %}
</div>
{% endblock %}

{% block card_body %}
<style>
    input {
        background-image: none !important;
    }
</style>
<div class="row g-3 mb-3">
    <div class="col-md-6">
        <form action="/attendance" method="GET" id="form-select-course">
            <div class="input-group shadow-sm">
                <span class="input-group-text bg-white border-end-0 text-primary"><i class="bi bi-search"></i></span>
                <select name="course_id" class="form-select border-start-0 fw-bold text-primary"
                        onchange="document.getElementById('form-select-course').submit()">
                    {% for kh in ds_khoa_hoc %}
                    <option value="{{ kh.ma_khoa_hoc }}" {{
                    'selected' if course and kh.ma_khoa_hoc == course.ma_khoa_hoc else '' }}>
                    {{ kh.ten_khoa_hoc }}
                    </option>
                    {% endfor %}
                </select>
            </div>
        </form>
    </div>
    <div class="col-md-6 text-md-end">
        {% if course %}
        <span class="badge bg-light text-dark border p-2">
            <i class="bi bi-calendar-event me-1"></i>Hôm nay: <strong>{{ today_str }}</strong>
        </span>
        {% endif %}
    </div>
</div>

{% if course %}

{% if student_rows and student_rows|length > 0 %}
<form action="/attendance" method="POST">
    <input type="hidden" name="course_id" value="{{ course.ma_khoa_hoc }}">

    <div id="mainTableContainer" class="table-responsive rounded shadow-sm border bg-white" style="max-height: 70vh;">
        <table class="table table-bordered mb-0 align-middle" style="border-collapse: separate; border-spacing: 0;">
            <thead class="bg-primary text-white header-row sticky-top">
            <tr>
                <th class="sticky-cell col-fix-left ps-3 bg-primary text-white"><i
                        class="bi bi-person-lines-fill me-2"></i>Học viên
                </th>
                {% for col in date_columns %}
                {% set is_today = (col['value'] == today_str) %}
                <th class="text-center py-2 {{ 'today-header' if is_today else 'bg-primary text-white' }}"
                    data-date="{{ col['value'] }}"
                    style="min-width: 110px;">
                    <small class="d-block opacity-75 fw-normal text-uppercase" style="font-size: 0.65rem;">{{
                        col['weekday'] }}</small>
                    <span class="fw-bold">{{ col['display'] }}</span>
                </th>
                {% endfor %}
                <th class="sticky-cell col-fix-right text-center bg-primary text-white">%</th>
            </tr>
            </thead>
            <tbody>
            {% for row in student_rows %}
            <tr>
                <td class="bg-light sticky-cell col-fix-left ps-3 border-end">
                    <div class="fw-bold text-truncate text-dark" style="max-width: 180px;"
                         title="{{ row['info'].ho_va_ten }}">
                        {{ row['info'].ho_va_ten }}
                    </div>
                    <small class="text-muted font-monospace" style="font-size: 0.8rem;">{{ row['info'].ma_nguoi_dung
                        }}</small>
                </td>

                {% for cell in row['cells'] %}
                {% set is_today = (cell['date'] == today_str) %}
                <td class="text-center p-1 {{ 'today-col' if is_today }}">
                    {% if cell['editable'] %}
                    <div class="btn-group btn-group-sm w-100 shadow-sm" role="group">
                        <input type="radio" class="btn-check"
                               name="att_{{ row['info'].ma_nguoi_dung }}_{{ cell['date'] }}"
                               id="r1_{{ row['info'].ma_nguoi_dung }}_{{ cell['date'] }}"
                               value="1" {{ 'checked' if cell['status'] == 1 }}>
                        <label class="btn btn-outline-success py-1 px-1" title="Có mặt"
                               for="r1_{{ row['info'].ma_nguoi_dung }}_{{ cell['date'] }}">
                            <i class="bi bi-check-lg"></i>
                        </label>

                        <input type="radio" class="btn-check"
                               name="att_{{ row['info'].ma_nguoi_dung }}_{{ cell['date'] }}"
                               id="r2_{{ row['info'].ma_nguoi_dung }}_{{ cell['date'] }}"
                               value="2" {{ 'checked' if cell['status'] == 2 }}>
                        <label class="btn btn-outline-warning py-1 px-1" title="Vắng có phép"
                               for="r2_{{ row['info'].ma_nguoi_dung }}_{{ cell['date'] }}">
                            P
                        </label>

                        <input type="radio" class="btn-check"
                               name="att_{{ row['info'].ma_nguoi_dung }}_{{ cell['date'] }}"
                               id="r3_{{ row['info'].ma_nguoi_dung }}_{{ cell['date'] }}"
                               value="3" {{ 'checked' if cell['status'] == 3 }}>
                        <label class="btn btn-outline-danger py-1 px-1" title="Vắng không phép"
                               for="r3_{{ row['info'].ma_nguoi_dung }}_{{ cell['date'] }}">
                            <i class="bi bi-x-lg"></i>
                        </label>
                    </div>
                    {% else %}
                    {% if cell['status'] == 1 %}<i class="bi bi-check-circle-fill text-success fs-5"></i>
                    {% elif cell['status'] == 2 %}<span class="badge bg-warning text-dark">P</span>
                    {% elif cell['status'] == 3 %}<i class="bi bi-x-circle-fill text-danger fs-5"></i>
                    {% else %}<span class="text-muted opacity-25">-</span>{% endif %}
                    {% endif %}
                </td>
                {% endfor %}

                <td class="sticky-cell bg-light col-fix-right text-center fw-bold border-start align-middle">
                            <span class="{{ 'text-success' if row['percent'] >= 80 else 'text-danger' }}">
                                {{ row['percent'] }}%
                            </span>
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="mt-3 d-flex justify-content-between align-items-center">
        <small class="text-muted fst-italic"><i class="bi bi-info-circle me-1"></i>Tự động cuộn đến ngày hiện
            tại.</small>
        <button type="submit" class="btn btn-primary px-4 fw-bold shadow-sm">
            <i class="bi bi-save me-2"></i>Lưu Dữ Liệu
        </button>
    </div>
</form>

{% else %}
<div class="text-center py-5 bg-white rounded shadow-sm border mt-3">
    <div class="mb-3">
        <i class="bi bi-people-fill display-4"></i>
    </div>
    <h5 class="text-muted fw-bold">Chưa có dữ liệu học viên</h5>
    <p class="text-muted mb-4">Lớp học này hiện tại chưa có học viên nào đăng ký.</p>
</div>
{% endif %}

{% else %}
<div class="alert alert-info text-center mt-4 shadow-sm border-0">
    <i class="bi bi-arrow-up-circle me-2"></i>Vui lòng chọn khóa học để xem danh sách điểm danh.
</div>
{% endif %}

{% endblock %}

{% block javascript %}
<script>
    document.addEventListener("DOMContentLoaded", function() {
        const scrollToDate = () => {
            const container = document.getElementById('mainTableContainer');
            const dateHeaders = document.querySelectorAll('th[data-date]');
            const stickyCol = document.querySelector('.col-fix-left');
            if (!container || !dateHeaders.length) return;
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            let targetHeader = null;
            for (let i = 0; i < dateHeaders.length; i++) {
                if (dateHeaders[i].getAttribute('data-date') >= todayStr) {
                    targetHeader = dateHeaders[i];
                    break;
                }
            }
            if (!targetHeader) {
                targetHeader = dateHeaders[dateHeaders.length - 1];
            }
            if (targetHeader) {
                const stickyWidth = stickyCol ? stickyCol.offsetWidth : 150;
                const scrollLeftPos = targetHeader.offsetLeft - stickyWidth - 5;
                container.scrollTo({
                    left: scrollLeftPos,
                    behavior: 'smooth'
                });
            }
        };
        scrollToDate();
        setTimeout(scrollToDate, 300);
    });
</script>
{% endblock %}